name: Deploy to Development Server

# mainブランチにプッシュされたときに実行
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. リポジトリのコードをチェックアウト
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. PHP環境をセットアップ (プロジェクトのバージョンに修正)
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, curl, gd, pdo_mysql # プロジェクトに必要な拡張機能
          coverage: none

      # 3. Node.js環境をセットアップ (プロジェクトのバージョンに修正)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      # 4. Composerのキャッシュを設定
      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      # 5. .envファイルをGitHub Secretsから作成
      # GitHubリポジトリの Settings > Secrets and variables > Actions で ENV_FILE を作成しておく
      - name: Create .env file
        run: echo "${{ secrets.ENV_FILE }}" > .env

      # 6. Composerの依存関係をインストール
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-dev --optimize-autoloader

      # 7. アプリケーションキーを生成
      - name: Generate application key
        run: php artisan key:generate

      # 8. JavaScript/CSSアセットをビルド
      - name: Install NPM dependencies and build
        run: |
          npm install
          npx vite build
        #npm run build

      # 9. サーバーにファイルをアップロード
      - name: Upload files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "./*"
          target: "/var/www/dev.kun.pink/project/center"   # サーバーの設置ディレクトリに変更

      # 10. サーバー側でキャッシュクリア＆権限調整
      - name: Run post-deploy commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/dev.kun.pink/project/center

            echo "キャッシュクリア..."
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            php artisan cache:clear

            echo "キャッシュ再構築..."
            php artisan config:cache
            php artisan route:cache
