name: Deploy to Development Server

# mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. PHPç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ä¿®æ­£)
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2' 
          extensions: mbstring, dom, curl, gd, pdo_mysql # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿…è¦ãªæ‹¡å¼µæ©Ÿèƒ½
          coverage: none

      # 3. Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ä¿®æ­£)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      
      # 4. Composerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¨­å®š
      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      # 5. .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’GitHub Secretsã‹ã‚‰ä½œæˆ
      # GitHubãƒªãƒã‚¸ãƒˆãƒªã® Settings > Secrets and variables > Actions ã§ ENV_FILE ã‚’ä½œæˆã—ã¦ãŠã
      - name: Create .env file
        run: echo "${{ secrets.ENV_FILE }}" > .env

      # 6. Composerã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-dev --optimize-autoloader

      # 7. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ã‚’ç”Ÿæˆ
      - name: Generate application key
        run: php artisan key:generate

      # 8. JavaScript/CSSã‚¢ã‚»ãƒƒãƒˆã‚’ãƒ“ãƒ«ãƒ‰
      - name: Install NPM dependencies and build
        run: |
          npm install
          npm run build

      # 9. å®Œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚µãƒ¼ãƒãƒ¼ã«è»¢é€ (rsyncã‚’ä½¿ç”¨)
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}      # ã‚µãƒ¼ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹
          username: ${{ secrets.SERVER_USER }}   # SSHãƒ¦ãƒ¼ã‚¶ãƒ¼å
          port: ${{ secrets.SERVER_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}    # SSHç§˜å¯†éµ
          script: |
            set -e # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚‰å‡¦ç†ã‚’ä¸­æ–­
            RELEASE_PATH="/var/www/dev.kun.pink/project/center/releases/$(date +%Y%m%d%H%M%S)"
            SHARED_PATH="/var/www/dev.kun.pink/project/center/shared"
            CURRENT_PATH="/var/www/dev.kun.pink/project/center/current"
            
            echo "Creating release directory: $RELEASE_PATH"
            mkdir -p $RELEASE_PATH
            
            echo "Syncing files..."
            rsync -avz --delete \
              --exclude '.git' \
              --exclude '.github' \
              --exclude 'storage' \
              --exclude '.env' \
              ./ $RELEASE_PATH/
            
            echo "Linking shared files and directories..."
            ln -nfs $SHARED_PATH/.env $RELEASE_PATH/.env
            ln -nfs $SHARED_PATH/storage $RELEASE_PATH/storage
            
            echo "Running post-deploy commands..."
            php $RELEASE_PATH/artisan migrate --force
            php $RELEASE_PATH/artisan optimize:clear
            
            echo "Switching symbolic link..."
            ln -nfs $RELEASE_PATH $CURRENT_PATH
            
            echo "Deployment successful! ğŸ‰"
